<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.JustDoIt.Mecca.KJH.mapper.GeneralMapper">

    <!-- 게시물 하나를 조회하는 쿼리 -->
    <select id="selectGeneralOne" parameterType="int" resultType="com.JustDoIt.Mecca.KJH.vo.General">
        SELECT * FROM GENERAL_TBL
        WHERE G_NO = #{gNo}
    </select>

    <!-- 게시물 삽입 쿼리 -->
    <insert id="insertGeneral" parameterType="com.JustDoIt.Mecca.KJH.vo.General">
        INSERT INTO GENERAL_TBL
        VALUES (SEQ_GENERAL_NO.NEXTVAL, #{gWriterEmail}, #{gTitle}, #{gContent}, DEFAULT, #{gView}, #{gLike})
    </insert>

    <!-- 게시물 수정 쿼리 -->
    <update id="updateGeneral" parameterType="com.JustDoIt.Mecca.KJH.vo.General">
        UPDATE GENERAL_TBL
        SET G_WRITER_EMAIL = #{gWriterEmail},
            G_TITLE = #{gTitle},
            G_CONTENT = #{gContent},
            G_VIEW = #{gView},
            G_LIKE = #{gLike}
        WHERE G_NO = #{gNo}
    </update>

    <!-- 게시물 삭제 쿼리 -->
    <delete id="deleteGeneral" parameterType="int">
        DELETE FROM GENERAL_TBL WHERE G_NO = #{gNo}
    </delete>

    <!-- 검색 총 개수 조회 -->
    <select id="getSearchTotalCount" parameterType="String" resultType="int">
        SELECT COUNT(*)
        FROM GENERAL_TBL
        WHERE G_TITLE LIKE '%' || #{searchQuery} || '%'
    </select>
    <!-- 페이지네이션 및 정렬 적용된 게시물 목록 조회 쿼리 -->
    <select id="searchGeneralList" parameterType="map" resultType="com.JustDoIt.Mecca.KJH.vo.General">
        SELECT *
        FROM GENERAL_TBL
        WHERE G_TITLE LIKE '%' || #{searchQuery} || '%'
        ORDER BY
        <choose>
            <when test="sortBy == 'latest'">G_CREATED_DATE DESC</when>
            <when test="sortBy == 'view'">G_VIEW DESC</when>
            <when test="sortBy == 'like'">G_LIKE DESC</when>
            <otherwise>G_NO DESC</otherwise>
        </choose>
    </select>

    <!-- 전체 게시물 수를 조회하는 쿼리 -->
    <select id="getTotalCount" resultType="int">
        SELECT COUNT(*) FROM GENERAL_TBL
    </select>
    <!-- 페이지에 맞는 게시물 목록을 조회하는 쿼리 -->
    <select id="selectGeneralList" parameterType="Map" resultType="com.JustDoIt.Mecca.KJH.vo.General">
        SELECT * FROM GENERAL_TBL ORDER BY
        <choose>
            <when test="sortBy == 'latest'">G_CREATED_DATE DESC</when>
            <when test="sortBy == 'view'">G_VIEW DESC</when>
            <when test="sortBy == 'like'">G_LIKE DESC</when>
            <otherwise>G_NO DESC</otherwise>
        </choose>
    </select>

    <!-- 게시물의 조회수를 1 증가시키는 쿼리 -->
    <update id="incrementViewCount" parameterType="int">
        UPDATE GENERAL_TBL
        SET G_VIEW = G_VIEW + 1
        WHERE G_NO = #{gNo}
    </update>

    <!-- 댓글 삽입 쿼리 -->
    <insert id="insertComment" parameterType="com.JustDoIt.Mecca.KJH.vo.GeneralComment">
        INSERT INTO GENERAL_COMMENT_TBL
        VALUES (SEQ_GENERAL_COMMENT_TBL.NEXTVAL, #{gcGNo}, #{gcWriterEmail}, #{gcContent}, DEFAULT)
    </insert>

    <!-- 댓글 조회 쿼리 -->
    <select id="selectCommentsByGeneralNo" parameterType="int" resultType="com.JustDoIt.Mecca.KJH.vo.GeneralComment">
        SELECT * FROM GENERAL_COMMENT_TBL
        WHERE GC_G_NO = #{gNo}
        ORDER BY GC_CREATED_DATE DESC
    </select>

    <!-- 댓글 삭제 쿼리 -->
    <delete id="deleteComment" parameterType="int">
        DELETE FROM GENERAL_COMMENT_TBL
        WHERE GC_NO = #{gcNo}
    </delete>

    <select id="getCommentsByGeneralNo" parameterType="int" resultType="com.JustDoIt.Mecca.KJH.vo.GeneralComment">
        SELECT * FROM GENERAL_COMMENT_TBL
        WHERE GC_G_NO = #{generalNo}
        ORDER BY GC_CREATED_DATE DESC
    </select>
</mapper>
